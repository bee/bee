#!/bin/bash
#
# bee-init - initialize bee-files from source-urls
#
# Copyright (C) 2009-2011
#       Marius Tolzmann <tolzmann@molgen.mpg.de>
#       Tobias Dreyer <dreyer@molgen.mpg.de>
#       and other bee developers
#
# This file is part of bee.
#
# bee is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#

set -e

if [ -z "${BEE_VERSION}" ] ; then
    echo >&2 "BEE-ERROR: please call $0 from bee .."
    exit 1
fi

VERSION=${BEE_VERSION}

function usage() {
    cat <<-EOF
	bee-init v${VERSION} 2009-2011
	  by Marius Tolzmann and Tobias Dreyer <{tolzmann,dreyer}@molgen.mpg.de>
	     Max Planck Institute for Molecular Genetics Berlin Dahlem

	Usage:
	bee init [options] <url>
	bee init [options] <pkgname> [url]

	Options:
	    -t [xorg|default]    specify template used for beefile
	    -f | --force         force overwriting of beefile
	    -h | --help          display this help

	EOF
}

function print_msg() {
    echo >&2 -e "${COLOR_BRACKET}[${COLOR_BRCONTENT}BEE${COLOR_BRACKET}] ${@}"
}

function print_info() {
    print_msg "${COLOR_INFO}${@}${COLOR_NORMAL}"
}

function print_error() {
    print_msg "${COLOR_ERROR}${@}${COLOR_NORMAL}"
}

function bee_versionify() {
    local -i i
    beefile=$1

    if [ "${OPT_VERSIONIFY}" != "yes" ] ; then
        return
    fi

    eval $(@BINDIR@/beeversion ${beefile} 2>/dev/null)

    if [ -z "${PKGREVISION}" ] ; then
        return
    fi

    i=${#PKGVERSION[@]}-2

    rules="-e 's,${PKGVERSION//\./\\.},\${PKGVERSION},g'"

    while [ $i -gt 1 ] ; do
       rules="${rules} -e 's,${PKGVERSION[$i]//\./\\.},\${PKGVERSION[$i]},g'"

       i=i-1
    done

    eval sed -i ${rules} ${beefile}
}

function create_beefile_from_template {
    beefile=$1
    templates=( $2 default fallback )
    local IFS=":${IFS}"

    for tmpl in ${templates[@]} ; do
        for dir in ${XDG_CONFIG_HOME} ${XDG_CONFIG_DIRS} ; do
            xdgtemplate="${dir}/bee/templates/${tmpl}"

            if [ -r "${xdgtemplate}" ] ; then
                : ${BEE_TEMPLATE=${xdgtemplate}}
            fi
        done
    done

    if [ ! -r "${BEE_TEMPLATE}" ] ; then
        print_error "no valid template found .."
        exit 1
    fi

    echo "creating ${beefile} from template '${BEE_TEMPLATE}'"
    cp ${BEE_TEMPLATE} ${beefile}
}

function initialize() {
    # get arguments starting with '--'
    while [ -n "${1}" ] ; do
        if [ "${1:0:2}" == "--" ] ; then
            DEFAULT_CONFIGURE_OPTIONS="${DEFAULT_CONFIGURE_OPTIONS:+${DEFAULT_CONFIGURE_OPTIONS} }${1}"
        else
            PP="${PP:+${PP} }${1}"
        fi
        shift
    done

    # set positional parameters to arguments not starting with '--'
    set -- ${PP}
    pname=$1
    surl=$2

    if [ -z "${surl}" ] ; then
        surl=${pname}

        # fix sourceforge urls for automatic pkgname generation
        if [[ $surl = *://sourceforge.net/*/files/*/download ]] ; then
            # strip /files directory
            surl=${surl/\/files\///}

            # rename directory /projects to /project
            surl=${surl/\/projects\///project/}

            # replace hostname sourceforge.net -> downloads.sourceforge.net
            surl=${surl/\/\/sourceforge.net\////downloads.sourceforge.net/}

            # strip /download basename
            surl=${surl%/download}

            pname=${surl}
        fi

        # start auto packagename generation with surl basename
        pname=${surl##*/}

        # strip some known and some special suffixes
        pname=${pname%.gz}
        pname=${pname%.bz2}
        pname=${pname%.zip}

        pname=${pname%.tgz}
        pname=${pname%.tbz2}

        pname=${pname%.tar}

        pname=${pname%.src}
        pname=${pname%-src}
        pname=${pname%.source}
        pname=${pname%-source}

        pname=${pname%.bee}

        if [ "${pname}" = "${surl}" ] ; then
            surl=""
        else
            pname=${pname}-0
        fi
    fi

    beefile="${pname}.bee"

    if [ -e "${beefile}" ] && [ "$OPT_FORCE" != "yes" ] ; then
        echo "${beefile} already exists .. use option -f to overwrite .."
        exit 1
    fi

    create_beefile_from_template ${beefile} ${TEMPLATE}

    sed -e "s,@SRCURL@,SRCURL[0]=\"${surl}\"," \
        -i ${beefile}

    sed -e "s,@DEFAULT_CONFIGURE_OPTIONS@,${DEFAULT_CONFIGURE_OPTIONS}," \
        -i ${beefile}

    for i in prefix eprefix bindir sbindir libexecdir sysconfdir \
              localstatedir sharedstatedir libdir includedir datarootdir \
              datadir infodir mandir docdirlocaledir ; do
        I=$(tr a-z A-Z <<<"${i}")
        eval dir=\$OPT_${i}
        DEFAULT_PREFIX_VARS="${DEFAULT_PREFIX_VARS:+${DEFAULT_PREFIX_VARS}}${dir:+${DEFAULT_PREFIX_VARS:+\n}}${dir:+${I}=${dir}}"
        unset dir
    done

    sed -e "s,@DEFAULT_PREFIX_VARS@,${DEFAULT_PREFIX_VARS}," \
        -i ${beefile}

    if [ "${CONFIGURE_BEEHAVIOR}" ] ; then
        sed -e "s,@BEE_CONFIGURE@,BEE_CONFIGURE=${CONFIGURE_BEEHAVIOR}," \
            -i ${beefile}
    else
        sed -e "s,@BEE_CONFIGURE@,# BEE_CONFIGURE=compat," \
            -i ${beefile}
    fi

    if [ -n "${OPT_BUILDTYPE}" ] ; then
        sed -e "s,@BEE_BUILDTYPE@,BEE_BUILDTYPE=\"${OPT_BUILDTYPE}\"," \
            -i ${beefile}
    else
        sed -e "s,@BEE_BUILDTYPE@,# BEE_BUILDTYPE=," \
            -i ${beefile}
    fi

    bee_versionify ${beefile}

    chmod 755 ${beefile}
}

options=$(getopt -n beeinit \
                 -o ht:f \
                 --long disable-versionify \
                 --long help,template:,force \
                 --long configure: \
                 --long prefix:,eprefix:,bindir:,sbindir:,libexecdir: \
                 --long sysconfdir:,localstatedir:,sharedstatedir: \
                 --long libdir:,includedir:,datarootdir:,datadir: \
                 --long infodir:,mandir:,docdir:,localedir: \
                 --long buildtype: \
                 -- "$@")

if [ $? != 0 ] ; then
    usage
    exit 1
fi

OPT_VERSIONIFY="yes"

eval set -- "${options}"

while true ; do
    case "$1" in
        -h|--help)
            usage
            exit 0
            ;;

        -t|--template)
            TEMPLATE=${2}
            shift 2
            ;;

        -f|--force)
            shift

            OPT_FORCE="yes"
            ;;

        --disable-versionify)
            shift
            OPT_VERSIONIFY="no"
            ;;

        --configure)
            case "${2}" in
                compat|none)
                    CONFIGURE_BEEHAVIOR=${2}
                    ;;
                *)
                    unset CONFIGURE_BEEHAVIOR
                    ;;
            esac
            shift 2
            ;;

        --prefix|\
        --eprefix|\
        --bindir|\
        --sbindir|\
        --libexecdir|\
        --sysconfdir|\
        --localstatedir|\
        --sharedstatedir|\
        --libdir|\
        --includedir|\
        --datarootdir|\
        --datadir|\
        --infodir|\
        --mandir|\
        --docdir|\
        --localedir)
            eval OPT_${1:2}="${2}"
            shift 2
            ;;

        --buildtype)
            OPT_BUILDTYPE="${2}"
            shift 2
            ;;

        *)
            shift
            if [ -z "${1}" ] ; then
                 usage
                 exit 1
            fi

            : ${TEMPLATE:=default}
            initialize ${@}
            exit 0;
            ;;
    esac
done
